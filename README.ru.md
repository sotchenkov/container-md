# container-md - Мониторинг контейнеров Docker, который автоматически перезапускается и уведомляет о unhealthy контейнерах

container-md - это простая, но эффективная утилита на Go, предназначенная для мониторинга состояния здоровья (`health status`) ваших запущенных Docker контейнеров. Когда контейнер становится `unhealthy` (нездоровым), container-md предпринимает действия: отправляет уведомление в Telegram с последними логами, пытается перезапустить контейнер и сообщает об успехе или неудаче попытки восстановления.

## Возможности

*   **Мониторинг состояния:** Периодически проверяет статус работоспособности запущенных Docker контейнеров.
*   **Обнаружение нездоровых контейнеров:** Идентифицирует контейнеры, помеченные как `unhealthy` механизмом проверки работоспособности Docker.
*   **Уведомления в Telegram:** Отправляет мгновенные оповещения в указанный чат Telegram при обнаружении нездорового контейнера.
*   **Фрагменты логов:** Включает последние несколько строк логов контейнера в первоначальное уведомление для быстрой диагностики.
*   **Автоматический перезапуск:** Пытается перезапустить нездоровый контейнер.
*   **Отчет о результате:** Отправляет последующее сообщение в Telegram, указывая, устранил ли перезапуск нездоровое состояние или нет.
*   **Настраиваемые интервалы:** Позволяет настраивать частоту проверок работоспособности и таймаут ожидания после перезапуска.
*   **Безопасность при параллельной работе:** Предотвращает одновременные многократные попытки перезапуска одного и того же экземпляра контейнера.
*   **Конфигурация через переменные окружения:** Простая настройка с использованием переменных окружения.
*   **Поддержка Docker Socket/Host:** Подключается к демону Docker через стандартный сокет или указанный `DOCKER_HOST`.

## Предварительные требования

*   **Go:** Версия 1.18 или новее (требуется только для сборки из исходного кода).
*   **Docker:** Демон Docker должен быть запущен и доступен. Пользователю, запускающему container-md, необходимо разрешение на доступ к сокету или API Docker.
*   **Telegram Бот:**
    *   Токен Telegram бота, полученный от BotFather.
    *   Chat ID пользователя или группы Telegram, куда должны отправляться уведомления.

## Конфигурация

container-md настраивается с помощью переменных окружения:

| Переменная                   | Обязательно | По умолчанию             | Описание                                                                      |
| :--------------------------- | :---------- | :----------------------- | :---------------------------------------------------------------------------- |
| `TELEGRAM_BOT_TOKEN`         | **Да**      |                          | API токен вашего Telegram бота.                                               |
| `TELEGRAM_CHAT_ID`           | **Да**      |                          | ID целевого чата Telegram для уведомлений.                                    |
| `CHECK_INTERVAL_SECONDS`     | Нет         | `60`                     | Интервал (в секундах) между проверками состояния контейнеров.               |
| `RESTART_WAIT_TIMEOUT_SECONDS` | Нет         | `90`                     | Время (в секундах) ожидания после перезапуска перед повторной проверкой.      |
| `LOG_TAIL_LINES`             | Нет         | `10`                     | Количество последних строк лога для включения в уведомление.                |
| `DOCKER_HOST`                | Нет         | По умолч. Docker клиента | Опционально. Укажите хост демона Docker (например, `unix:///var/run/docker.sock`). |

## Установка и Использование

### Вариант 1: Запуск бинарного файла

1.  **Клонировать репозиторий (Опционально):**
    ```bash
    git clone https://github.com/sotchenkov/container-md.git# Замените на ваш путь к репозиторию
    cd container-md
    ```
2.  **Собрать:**
    ```bash
    go build -o container-md .
    ```
3.  **Установить переменные окружения:**
    ```bash
    export TELEGRAM_BOT_TOKEN="ВАШ_BOT_TOKEN"
    export TELEGRAM_CHAT_ID="ВАШ_CHAT_ID"
    # Опционально:
    # export CHECK_INTERVAL_SECONDS="30"
    # export RESTART_WAIT_TIMEOUT_SECONDS="60"
    # export LOG_TAIL_LINES="15"
    # export DOCKER_HOST="unix:///var/run/docker.sock"
    ```
4.  **Запустить:**
    ```bash
    ./container-md
    ```

### Вариант 2: Запуск с помощью Docker

1.  **Собрать Docker образ:**
    ```bash
    docker build -t container-md .
    ```
2.  **Запустить Docker контейнер:**
    ```bash
    docker run --rm -d \
      --name container-md \
      -e TELEGRAM_BOT_TOKEN="ВАШ_BOT_TOKEN" \
      -e TELEGRAM_CHAT_ID="ВАШ_CHAT_ID" \
      -e CHECK_INTERVAL_SECONDS="60" \
      -e RESTART_WAIT_TIMEOUT_SECONDS="90" \
      -e LOG_TAIL_LINES="10" \
      -v /var/run/docker.sock:/var/run/docker.sock \
      container-md
    ```
    *Примечание: Отрегулируйте монтирование тома (`-v`), если путь к вашему сокету Docker отличается или если используется TCP (`DOCKER_HOST` переменная окружения).*

## Как это работает

1.  **Цикл проверки:** container-md периодически запрашивает список запущенных контейнеров через Docker API.
2.  **Инспекция:** Для каждого контейнера он проверяет его состояние, обращая особое внимание на статус `Health`.
3.  **Обнаружение нездорового состояния:** Если статус работоспособности контейнера `unhealthy`:
    *   Он помечает ID контейнера как обрабатываемый, чтобы избежать дублирования действий.
    *   Он извлекает последние N строк логов из контейнера.
    *   Он отправляет первоначальное уведомление в Telegram с именем контейнера и фрагментом лога.
4.  **Перезапуск:** container-md отправляет команду перезапуска нездоровому контейнеру.
5.  **Ожидание и повторная проверка:** Он ожидает настроенную продолжительность (`RESTART_WAIT_TIMEOUT_SECONDS`), чтобы дать контейнеру время стабилизироваться после перезапуска. Затем он снова проверяет контейнер.
6.  **Финальное уведомление:** В зависимости от состояния контейнера и статуса работоспособности после ожидания:
    *   Если `healthy`: Отправляет уведомление об успехе.
    *   Если все еще `unhealthy` или в другом нерабочем, но запущенном состоянии: Отправляет уведомление о неудаче.
    *   Если контейнер остановлен или не найден: Отправляет соответствующее уведомление о неудаче.
7.  **Разблокировка:** Удаляет ID контейнера из списка "обрабатываемых".
8.  **Повторение:** Цикл проверки продолжается.

## Участие в разработке

Вклад приветствуется! Пожалуйста, не стесняйтесь отправлять Pull Request или создавать Issue.

## Лицензия

Этот проект лицензирован под лицензией GPL-3.0 license - см. файл [LICENSE](LICENSE) для подробностей.